# name: test/sql/join/asof/test_asof_join_doubles.test
# description: Test As-Of joins for floating point
# group: [asof]

#
# Inequality only
#
#
# With equality
#

statement ok
CREATE TABLE events (key INTEGER, begin DOUBLE, value INTEGER);

statement ok
INSERT INTO events VALUES
	(1, 1, 0),
	(1, 3, 1),
	(1, 6, 2),
	(1, 8, 3),
	(2, 0, 10),
	(2, 7, 20),
	(2, 11, 30)
;

statement ok
CREATE TABLE probes AS
	(SELECT key::DOUBLE as key, ts::DOUBLE as ts
	FROM range(1,3) k(key) CROSS JOIN range(0,10) t(ts)
	);

# INNER Window version
query III nosort inner_equality
SELECT p.key, p.ts, e.value
FROM 
	probes p
JOIN (
	SELECT key, value, begin, 
		LEAD(begin, 1, '999'::DOUBLE) OVER (PARTITION BY key ORDER BY begin ASC) AS ed
	FROM events
) e
ON p.key = e.key AND p.ts >= e.begin AND p.ts < e.ed
ORDER BY 1, 2 ASC
----
1.0 1.0 0
1.0 2.0 0
1.0 3.0 1
1.0 4.0 1
1.0 5.0 1
1.0 6.0 2
1.0 7.0 2
1.0 8.0 3
1.0 9.0 3
2.0 0.0 10
2.0 1.0 10
2.0 2.0 10
2.0 3.0 10
2.0 4.0 10
2.0 5.0 10
2.0 6.0 10
2.0 7.0 20
2.0 8.0 20
2.0 9.0 20

# INNER ON with equality
query III nosort inner_equality
SELECT p.key, p.ts, e.value
FROM probes p ASOF JOIN events e
  ON p.key = e.key AND p.ts >= e.begin
ORDER BY 1, 2 ASC
----
1.0 1.0 0
1.0 2.0 0
1.0 3.0 1
1.0 4.0 1
1.0 5.0 1
1.0 6.0 2
1.0 7.0 2
1.0 8.0 3
1.0 9.0 3
2.0 0.0 10
2.0 1.0 10
2.0 2.0 10
2.0 3.0 10
2.0 4.0 10
2.0 5.0 10
2.0 6.0 10
2.0 7.0 20
2.0 8.0 20
2.0 9.0 20

